<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen p-6 font-sans">

  <div class="max-w-2xl mx-auto">
    <h1 class="text-4xl text-center font-black mb-8 text-yellow-500 tracking-tight">üèÜ GLOBAL RANKINGS</h1>

    <div class="flex justify-center mb-10">
      <div class="relative w-full max-w-xs">
        <select id="category-select" class="w-full bg-gray-800 border-2 border-gray-700 text-white px-4 py-3 rounded-2xl appearance-none focus:outline-none focus:border-yellow-500 transition cursor-pointer">
          <option value="HTML">HTML Category</option>
          <option value="CSS">CSS Category</option>
          <option value="JavaScript">JavaScript Category</option>
          <option value="Java">Java Category</option>
          <option value="C++">C++ Category</option>
        </select>
        <div class="absolute right-4 top-4 pointer-events-none text-gray-400">‚ñº</div>
      </div>
    </div>

    <div class="bg-gray-800 rounded-3xl shadow-2xl overflow-hidden border border-gray-700">
      <div class="flex items-center justify-between px-8 py-4 bg-gray-700/50 text-xs font-bold uppercase tracking-widest text-gray-400">
        <span>Rank & User</span>
        <span>Score</span>
      </div>
      
      <ul id="list" class="divide-y divide-gray-700">
        </ul>
    </div>

    <div class="mt-8 text-center">
      <a href="dashboard.html" class="inline-block bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-xl text-sm font-semibold transition">Back to Categories</a>
    </div>
  </div>

  <script type="module">
    import { collection, getDocs, query, orderBy, where }
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { db } from "./firebase.js";

    const list = document.getElementById("list");
    const categorySelect = document.getElementById("category-select");

    // Rank Medal Logic
    function getRankBadge(rank) {
      if (rank === 1) return '<span class="text-3xl">ü•á</span>';
      if (rank === 2) return '<span class="text-3xl">ü•à</span>';
      if (rank === 3) return '<span class="text-3xl">ü•â</span>';
      return `<span class="w-8 h-8 flex items-center justify-center bg-gray-700 rounded-full text-sm font-bold">${rank}</span>`;
    }

    async function fetchLeaderboard() {
      const selectedCategory = categorySelect.value;
      list.innerHTML = `<div class="p-10 text-center text-gray-500 animate-pulse">Fetching Rankings...</div>`;

      try {
        // Query Category wise and Order by Score
        const q = query(
          collection(db, "leaderboard"),
          where("category", "==", selectedCategory),
          orderBy("score", "desc")
        );

        const snapshot = await getDocs(q);
        list.innerHTML = "";

        let rank = 1;
        snapshot.forEach(doc => {
          const d = doc.data();
          const li = document.createElement("li");
          
          // Special styling for top 3
          const isTop3 = rank <= 3;
          const bgEffect = isTop3 ? 'bg-yellow-500/5' : 'hover:bg-gray-700/30';

          li.className = `flex items-center justify-between px-8 py-5 transition ${bgEffect}`;
          
          li.innerHTML = `
            <div class="flex items-center gap-5">
              ${getRankBadge(rank)}
              <div>
                <p class="font-bold text-lg ${isTop3 ? 'text-white' : 'text-gray-300'}">${d.user}</p>
                <p class="text-xs text-gray-500 uppercase font-medium">${d.category}</p>
              </div>
            </div>
            <div class="text-right">
              <span class="text-2xl font-black ${isTop3 ? 'text-yellow-500' : 'text-gray-400'}">${d.score}</span>
              <p class="text-[10px] text-gray-600 font-bold uppercase tracking-tighter">Points</p>
            </div>
          `;
          list.appendChild(li);
          rank++;
        });

        if (rank === 1) {
          list.innerHTML = `<div class="p-10 text-center text-gray-500 italic">No rankings found for this category yet.</div>`;
        }
      } catch (error) {
        console.error("Leaderboard Error:", error);
        list.innerHTML = `<div class="p-10 text-center text-red-400 text-sm">Error loading data. Make sure you have created the required Composite Index in Firebase Console.</div>`;
      }
    }

    // Change leaderboard on selection
    categorySelect.addEventListener("change", fetchLeaderboard);
    
    // Initial Load
    fetchLeaderboard();
  </script>

</body>
</html>